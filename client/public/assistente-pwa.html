<!doctype html>
<html lang="pt">

  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>Assistente IA - PoweringEG</title>
    <link rel="icon" type="image/png" href="/poweringeg-ai-icon-192.png" />
    <!-- PWA - Manifest específico do Assistente IA -->
    <link rel="manifest" href="/manifest-assistente.json" />
    <meta name="theme-color" content="#7c3aed" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Assistente IA" />
    <link rel="apple-touch-icon" href="/poweringeg-ai-icon-192.png" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: system-ui, -apple-system, sans-serif;
        padding: 20px;
      }
      .container {
        text-align: center;
        max-width: 400px;
      }
      .icon {
        width: 96px;
        height: 96px;
        margin: 0 auto 24px;
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(124, 58, 237, 0.3);
      }
      h1 {
        color: #5b21b6;
        font-size: 24px;
        margin-bottom: 8px;
      }
      p {
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 24px;
      }
      .loading {
        color: #7c3aed;
        margin-bottom: 24px;
      }
      .loading svg {
        width: 32px;
        height: 32px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .install-btn {
        display: none;
        background: #7c3aed;
        color: white;
        border: none;
        padding: 14px 28px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        margin-bottom: 16px;
        width: 100%;
        max-width: 280px;
        transition: all 0.2s ease;
      }
      .install-btn:hover {
        background: #6d28d9;
        transform: translateY(-1px);
      }
      .install-btn:active {
        transform: scale(0.98);
      }
      .install-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
      }
      .skip-btn {
        display: none;
        background: transparent;
        color: #7c3aed;
        border: 2px solid #7c3aed;
        padding: 12px 24px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 12px;
        cursor: pointer;
        width: 100%;
        max-width: 280px;
        transition: all 0.2s ease;
      }
      .skip-btn:hover {
        background: rgba(124, 58, 237, 0.1);
      }
      .ios-instructions {
        display: none;
        background: white;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        text-align: left;
        margin-top: 20px;
      }
      .ios-instructions h3 {
        color: #5b21b6;
        font-size: 16px;
        margin-bottom: 12px;
      }
      .ios-instructions ol {
        color: #374151;
        font-size: 14px;
        padding-left: 20px;
      }
      .ios-instructions li {
        margin-bottom: 8px;
      }
      .status-msg {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 16px;
        min-height: 20px;
      }
      .debug-info {
        display: none;
        font-size: 10px;
        color: #9ca3af;
        margin-top: 24px;
        padding: 12px;
        background: rgba(0,0,0,0.05);
        border-radius: 8px;
        text-align: left;
        word-break: break-all;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <img src="/poweringeg-ai-icon-192.png" alt="Assistente IA" class="icon" />
      <h1>Assistente IA</h1>
      <p>Assistente inteligente para gestores Express Glass</p>
      
      <div class="loading" id="loading">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        <p style="margin-top: 8px; font-size: 12px;">A preparar...</p>
      </div>
      
      <button class="install-btn" id="installBtn">
        Instalar Assistente IA
      </button>
      
      <button class="skip-btn" id="skipBtn">
        Continuar sem instalar
      </button>
      
      <div class="ios-instructions" id="iosInstructions">
        <h3>Como instalar no iPhone/iPad:</h3>
        <ol>
          <li>Toque no botão <strong>Partilhar</strong> (ícone com seta para cima)</li>
          <li>Deslize para baixo e toque em <strong>"Adicionar ao Ecrã Principal"</strong></li>
          <li>Toque em <strong>"Adicionar"</strong> no canto superior direito</li>
        </ol>
      </div>
      
      <p class="status-msg" id="statusMsg"></p>
      
      <div class="debug-info" id="debugInfo"></div>
    </div>

    <script>
      // Estado global
      let deferredPrompt = null;
      let installAttempted = false;
      
      // Deteção de dispositivo/browser
      const ua = navigator.userAgent;
      const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
      const isChrome = /Chrome/.test(ua) && /Google Inc/.test(navigator.vendor);
      const isFirefox = /Firefox/.test(ua);
      const isEdge = /Edg/.test(ua);
      const isAndroid = /Android/.test(ua);
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                           window.navigator.standalone === true;
      
      // Elementos DOM
      const loadingEl = document.getElementById('loading');
      const installBtn = document.getElementById('installBtn');
      const skipBtn = document.getElementById('skipBtn');
      const iosInstructions = document.getElementById('iosInstructions');
      const statusMsg = document.getElementById('statusMsg');
      const debugInfo = document.getElementById('debugInfo');
      
      // Funções de debug (ativar com ?debug=1 no URL)
      const urlParams = new URLSearchParams(window.location.search);
      const debugMode = urlParams.get('debug') === '1';
      
      function log(msg) {
        console.log('[PWA]', msg);
        if (debugMode) {
          debugInfo.style.display = 'block';
          debugInfo.innerHTML += msg + '<br>';
        }
      }
      
      function setStatus(msg) {
        statusMsg.textContent = msg;
        log('Status: ' + msg);
      }
      
      // Se já está em modo standalone, ir direto para a app
      if (isStandalone) {
        log('Já em modo standalone, redirecionando...');
        window.location.replace('/assistente-widget');
      }
      
      log('UA: ' + ua.substring(0, 50) + '...');
      log('iOS: ' + isIOS + ', Safari: ' + isSafari + ', Chrome: ' + isChrome);
      log('Android: ' + isAndroid + ', Standalone: ' + isStandalone);
      
      // Capturar o evento de instalação ANTES de qualquer outra coisa
      window.addEventListener('beforeinstallprompt', (e) => {
        log('beforeinstallprompt capturado!');
        e.preventDefault();
        deferredPrompt = e;
        showInstallUI();
      });
      
      // Listener para quando a app é instalada
      window.addEventListener('appinstalled', () => {
        log('App instalada com sucesso!');
        setStatus('Instalado com sucesso!');
        deferredPrompt = null;
        setTimeout(() => {
          window.location.replace('/assistente-widget');
        }, 1000);
      });
      
      function showInstallUI() {
        log('Mostrando UI de instalação');
        loadingEl.style.display = 'none';
        installBtn.style.display = 'block';
        skipBtn.style.display = 'block';
        installBtn.textContent = 'Instalar Assistente IA';
        installBtn.disabled = false;
        installBtn.onclick = installApp;
        setStatus('');
      }
      
      function showIOSInstructions() {
        log('Mostrando instruções iOS');
        loadingEl.style.display = 'none';
        iosInstructions.style.display = 'block';
        skipBtn.style.display = 'block';
        setStatus('');
      }
      
      function showOpenAppUI() {
        log('Mostrando UI de abrir app');
        loadingEl.style.display = 'none';
        installBtn.style.display = 'block';
        skipBtn.style.display = 'block';
        installBtn.textContent = 'Abrir Assistente IA';
        installBtn.onclick = skipToApp;
        setStatus('A instalação não está disponível neste browser');
      }
      
      async function installApp() {
        log('Tentando instalar...');
        
        if (!deferredPrompt) {
          log('Sem deferredPrompt disponível');
          setStatus('Instalação não disponível. Use o menu do browser.');
          return;
        }
        
        installBtn.disabled = true;
        installBtn.textContent = 'A instalar...';
        setStatus('A processar...');
        
        try {
          // Mostrar o prompt de instalação
          deferredPrompt.prompt();
          log('Prompt mostrado');
          
          // Aguardar a escolha do utilizador
          const { outcome } = await deferredPrompt.userChoice;
          log('Escolha do utilizador: ' + outcome);
          
          if (outcome === 'accepted') {
            setStatus('Instalação aceite!');
            // O evento appinstalled irá tratar do redirecionamento
          } else {
            setStatus('Instalação cancelada');
            installBtn.disabled = false;
            installBtn.textContent = 'Instalar Assistente IA';
          }
        } catch (err) {
          log('Erro na instalação: ' + err.message);
          setStatus('Erro: ' + err.message);
          installBtn.disabled = false;
          installBtn.textContent = 'Tentar novamente';
        }
        
        // Limpar o prompt (só pode ser usado uma vez)
        deferredPrompt = null;
      }
      
      function skipToApp() {
        log('Redirecionando para app...');
        window.location.replace('/assistente-widget');
      }
      
      // Associar eventos aos botões
      installBtn.onclick = installApp;
      skipBtn.onclick = skipToApp;
      
      // Verificar após um delay se podemos mostrar a UI de instalação
      setTimeout(() => {
        log('Verificação após timeout...');
        
        if (isIOS) {
          // iOS não suporta beforeinstallprompt
          showIOSInstructions();
        } else if (deferredPrompt) {
          // Temos o prompt, mostrar UI de instalação
          showInstallUI();
        } else {
          // Não temos o prompt - verificar razões possíveis
          log('Sem prompt disponível após timeout');
          
          // Verificar se o service worker está registado
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistration().then(reg => {
              if (reg) {
                log('Service Worker registado: ' + reg.scope);
              } else {
                log('Nenhum Service Worker registado');
              }
            }).catch(err => {
              log('Erro ao verificar SW: ' + err.message);
            });
          }
          
          // Mostrar UI alternativa
          showOpenAppUI();
        }
      }, 2500);
      
      // Tentar registar o service worker se ainda não estiver registado
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw-assistente.js', { scope: '/' })
          .then(reg => {
            log('SW registado: ' + reg.scope);
          })
          .catch(err => {
            log('Erro ao registar SW: ' + err.message);
          });
      }
    </script>
  </body>

</html>
