<!doctype html>
<html lang="pt">

  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>PoweringEG</title>
    <link rel="icon" type="image/png" href="/poweringeg-ai-icon-192.png" />
    <!-- PWA - Manifest espec√≠fico do Assistente IA -->
    <link rel="manifest" href="/manifest-assistente.json" />
    <meta name="theme-color" content="#7c3aed" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="PoweringEG" />
    <link rel="apple-touch-icon" href="/poweringeg-ai-icon-192.png" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: system-ui, -apple-system, sans-serif;
        padding: 20px;
      }
      .container {
        text-align: center;
        max-width: 400px;
      }
      .icon {
        width: 96px;
        height: 96px;
        margin: 0 auto 24px;
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(124, 58, 237, 0.3);
      }
      h1 {
        color: #5b21b6;
        font-size: 24px;
        margin-bottom: 8px;
      }
      p {
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 24px;
      }
      .loading {
        color: #7c3aed;
        margin-bottom: 24px;
      }
      .loading svg {
        width: 32px;
        height: 32px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .install-btn {
        display: none;
        background: #7c3aed;
        color: white;
        border: none;
        padding: 14px 28px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        margin-bottom: 16px;
        width: 100%;
        max-width: 280px;
        transition: all 0.2s ease;
      }
      .install-btn:hover {
        background: #6d28d9;
        transform: translateY(-1px);
      }
      .install-btn:active {
        transform: scale(0.98);
      }
      .install-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
      }
      .skip-btn {
        display: none;
        background: transparent;
        color: #7c3aed;
        border: 2px solid #7c3aed;
        padding: 12px 24px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 12px;
        cursor: pointer;
        width: 100%;
        max-width: 280px;
        transition: all 0.2s ease;
      }
      .skip-btn:hover {
        background: rgba(124, 58, 237, 0.1);
      }
      .instructions {
        display: none;
        background: white;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        text-align: left;
        margin-top: 20px;
        margin-bottom: 20px;
      }
      .instructions h3 {
        color: #5b21b6;
        font-size: 16px;
        margin-bottom: 12px;
      }
      .instructions ol {
        color: #374151;
        font-size: 14px;
        padding-left: 20px;
      }
      .instructions li {
        margin-bottom: 8px;
      }
      .instructions .highlight {
        background: #f5f3ff;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        color: #5b21b6;
      }
      .status-msg {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 16px;
        min-height: 20px;
      }
      .info-box {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 12px;
        padding: 12px 16px;
        margin-bottom: 20px;
        display: none;
      }
      .info-box p {
        color: #92400e;
        font-size: 13px;
        margin: 0;
      }
      .debug-info {
        display: none;
        font-size: 10px;
        color: #9ca3af;
        margin-top: 24px;
        padding: 12px;
        background: rgba(0,0,0,0.05);
        border-radius: 8px;
        text-align: left;
        word-break: break-all;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <img src="/poweringeg-ai-icon-192.png" alt="PoweringEG" class="icon" />
      <h1>PoweringEG</h1>
      <p>Assistente inteligente para gestores Express Glass</p>
      
      <div class="loading" id="loading">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        <p style="margin-top: 8px; font-size: 12px;">A verificar...</p>
      </div>
      
      <div class="info-box" id="infoBox">
        <p>üí° Se o bot√£o de instalar n√£o aparecer, use o menu do browser (‚ãÆ) e selecione "Instalar aplica√ß√£o" ou "Adicionar ao ecr√£ inicial".</p>
      </div>
      
      <button class="install-btn" id="installBtn">
        Instalar PoweringEG
      </button>
      
      <button class="skip-btn" id="skipBtn">
        Continuar sem instalar
      </button>
      
      <div class="instructions" id="iosInstructions">
        <h3>üì± Como instalar no iPhone/iPad:</h3>
        <ol>
          <li>Toque no bot√£o <span class="highlight">Partilhar</span> (√≠cone com seta para cima)</li>
          <li>Deslize para baixo e toque em <span class="highlight">"Adicionar ao Ecr√£ Principal"</span></li>
          <li>Toque em <span class="highlight">"Adicionar"</span> no canto superior direito</li>
        </ol>
      </div>
      
      <div class="instructions" id="chromeInstructions">
        <h3>üåê Como instalar no Chrome/Edge:</h3>
        <ol>
          <li>Clique no menu <span class="highlight">‚ãÆ</span> (tr√™s pontos) no canto superior direito</li>
          <li>Selecione <span class="highlight">"Instalar PoweringEG..."</span> ou <span class="highlight">"Instalar aplica√ß√£o"</span></li>
          <li>Confirme clicando em <span class="highlight">"Instalar"</span></li>
        </ol>
      </div>
      
      <p class="status-msg" id="statusMsg"></p>
      
      <div class="debug-info" id="debugInfo"></div>
    </div>

    <script>
      // Estado global
      let deferredPrompt = null;
      let manifestLoaded = false;
      
      // Dete√ß√£o de dispositivo/browser
      const ua = navigator.userAgent;
      const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
      const isChrome = /Chrome/.test(ua) && /Google Inc/.test(navigator.vendor);
      const isFirefox = /Firefox/.test(ua);
      const isEdge = /Edg/.test(ua);
      const isAndroid = /Android/.test(ua);
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                           window.navigator.standalone === true;
      
      // Elementos DOM
      const loadingEl = document.getElementById('loading');
      const installBtn = document.getElementById('installBtn');
      const skipBtn = document.getElementById('skipBtn');
      const iosInstructions = document.getElementById('iosInstructions');
      const chromeInstructions = document.getElementById('chromeInstructions');
      const statusMsg = document.getElementById('statusMsg');
      const debugInfo = document.getElementById('debugInfo');
      const infoBox = document.getElementById('infoBox');
      
      // Fun√ß√µes de debug (ativar com ?debug=1 no URL)
      const urlParams = new URLSearchParams(window.location.search);
      const debugMode = urlParams.get('debug') === '1';
      
      function log(msg) {
        console.log('[PWA]', msg);
        if (debugMode) {
          debugInfo.style.display = 'block';
          debugInfo.innerHTML += msg + '<br>';
        }
      }
      
      function setStatus(msg) {
        statusMsg.textContent = msg;
        log('Status: ' + msg);
      }
      
      // Se j√° est√° em modo standalone, ir direto para a app
      if (isStandalone) {
        log('J√° em modo standalone, redirecionando...');
        window.location.replace('/assistente-widget');
      }
      
      log('UA: ' + ua.substring(0, 50) + '...');
      log('iOS: ' + isIOS + ', Safari: ' + isSafari + ', Chrome: ' + isChrome);
      log('Android: ' + isAndroid + ', Standalone: ' + isStandalone);
      
      // Capturar o evento de instala√ß√£o ANTES de qualquer outra coisa
      window.addEventListener('beforeinstallprompt', (e) => {
        log('beforeinstallprompt capturado!');
        e.preventDefault();
        deferredPrompt = e;
        showInstallUI();
      });
      
      // Listener para quando a app √© instalada
      window.addEventListener('appinstalled', () => {
        log('App instalada com sucesso!');
        setStatus('Instalado com sucesso! A abrir...');
        deferredPrompt = null;
        setTimeout(() => {
          window.location.replace('/assistente-widget');
        }, 1500);
      });
      
      function showInstallUI() {
        log('Mostrando UI de instala√ß√£o');
        loadingEl.style.display = 'none';
        installBtn.style.display = 'block';
        skipBtn.style.display = 'block';
        installBtn.textContent = 'Instalar PoweringEG';
        installBtn.disabled = false;
        installBtn.onclick = installApp;
        setStatus('');
      }
      
      function showIOSInstructions() {
        log('Mostrando instru√ß√µes iOS');
        loadingEl.style.display = 'none';
        iosInstructions.style.display = 'block';
        skipBtn.style.display = 'block';
        setStatus('');
      }
      
      function showChromeInstructions() {
        log('Mostrando instru√ß√µes Chrome/Edge');
        loadingEl.style.display = 'none';
        chromeInstructions.style.display = 'block';
        infoBox.style.display = 'block';
        skipBtn.style.display = 'block';
        setStatus('Use o menu do browser para instalar');
      }
      
      function showOpenAppUI() {
        log('Mostrando UI de abrir app');
        loadingEl.style.display = 'none';
        installBtn.style.display = 'block';
        skipBtn.style.display = 'block';
        installBtn.textContent = 'Abrir PoweringEG';
        installBtn.onclick = skipToApp;
        
        // Mostrar instru√ß√µes de instala√ß√£o manual
        if (isChrome || isEdge) {
          chromeInstructions.style.display = 'block';
          infoBox.style.display = 'block';
        }
        
        setStatus('');
      }
      
      async function installApp() {
        log('Tentando instalar...');
        
        if (!deferredPrompt) {
          log('Sem deferredPrompt dispon√≠vel');
          // Mostrar instru√ß√µes manuais
          if (isChrome || isEdge) {
            showChromeInstructions();
          } else {
            setStatus('Use o menu do browser para instalar');
          }
          return;
        }
        
        installBtn.disabled = true;
        installBtn.textContent = 'A instalar...';
        setStatus('A processar...');
        
        try {
          // Mostrar o prompt de instala√ß√£o
          deferredPrompt.prompt();
          log('Prompt mostrado');
          
          // Aguardar a escolha do utilizador
          const { outcome } = await deferredPrompt.userChoice;
          log('Escolha do utilizador: ' + outcome);
          
          if (outcome === 'accepted') {
            setStatus('Instala√ß√£o aceite!');
            // O evento appinstalled ir√° tratar do redirecionamento
          } else {
            setStatus('Instala√ß√£o cancelada');
            installBtn.disabled = false;
            installBtn.textContent = 'Instalar PoweringEG';
          }
        } catch (err) {
          log('Erro na instala√ß√£o: ' + err.message);
          setStatus('Erro: ' + err.message);
          installBtn.disabled = false;
          installBtn.textContent = 'Tentar novamente';
        }
        
        // Limpar o prompt (s√≥ pode ser usado uma vez)
        deferredPrompt = null;
      }
      
      function skipToApp() {
        log('Redirecionando para app...');
        window.location.replace('/assistente-widget');
      }
      
      // Associar eventos aos bot√µes
      installBtn.onclick = installApp;
      skipBtn.onclick = skipToApp;
      
      // Verificar se o manifest carregou corretamente
      async function checkManifest() {
        try {
          const response = await fetch('/manifest-assistente.json');
          if (response.ok) {
            manifestLoaded = true;
            log('Manifest carregado com sucesso');
          } else {
            log('Erro ao carregar manifest: ' + response.status);
          }
        } catch (err) {
          log('Erro ao verificar manifest: ' + err.message);
        }
      }
      
      // Verificar ap√≥s um delay se podemos mostrar a UI de instala√ß√£o
      setTimeout(async () => {
        log('Verifica√ß√£o ap√≥s timeout...');
        
        await checkManifest();
        
        if (isIOS) {
          // iOS n√£o suporta beforeinstallprompt
          showIOSInstructions();
        } else if (deferredPrompt) {
          // Temos o prompt, mostrar UI de instala√ß√£o
          showInstallUI();
        } else {
          // N√£o temos o prompt - mostrar instru√ß√µes alternativas
          log('Sem prompt dispon√≠vel ap√≥s timeout');
          showOpenAppUI();
        }
      }, 2000);
      
      // Tentar registar o service worker se ainda n√£o estiver registado
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw-assistente.js', { scope: '/' })
          .then(reg => {
            log('SW registado: ' + reg.scope);
          })
          .catch(err => {
            log('Erro ao registar SW: ' + err.message);
          });
      }
    </script>
  </body>

</html>
